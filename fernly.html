<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fernly Financial Model</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .container {
            background: white;
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }
        h1 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 32px;
        }
        .subtitle {
            color: #7f8c8d;
            margin-bottom: 30px;
            font-size: 18px;
        }
        .button-container {
            text-align: center;
            margin: 40px 0;
            padding: 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 12px;
        }
        button {
            background: white;
            color: #667eea;
            border: none;
            padding: 25px 50px;
            font-size: 20px;
            font-weight: bold;
            border-radius: 8px;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
        }
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }
        button:active {
            transform: translateY(0);
        }
        button:disabled {
            background: #95a5a6;
            color: white;
            cursor: not-allowed;
            transform: none;
        }
        .info-section {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 8px;
            margin: 25px 0;
            border-left: 4px solid #667eea;
        }
        .info-section h3 {
            margin-top: 0;
            color: #2c3e50;
            font-size: 20px;
        }
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        .info-item {
            background: white;
            padding: 15px;
            border-radius: 6px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .info-item strong {
            color: #667eea;
            display: block;
            margin-bottom: 5px;
        }
        .status {
            margin: 20px 0;
            padding: 20px;
            border-radius: 8px;
            display: none;
            text-align: center;
            font-size: 18px;
            font-weight: bold;
        }
        .status.success {
            background: #d4edda;
            color: #155724;
            display: block;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
            display: block;
        }
        ul {
            line-height: 1.8;
        }
        .icon {
            font-size: 24px;
            margin-right: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üìä Fernly Health Financial Model</h1>
        <p class="subtitle">3-Year Financial Projection (2028-2030)</p>
        
        <div class="button-container">
            <button onclick="generateExcel()" id="generateBtn">
                <span class="icon">‚¨áÔ∏è</span> CLICK HERE TO GENERATE EXCEL FILE
            </button>
        </div>
        
        <div id="status" class="status"></div>
        
        <div class="info-section">
            <h3>üìã Model Overview</h3>
            <p>This financial model generates a comprehensive 36-month projection with the following worksheets:</p>
            <ul>
                <li><strong>Assumptions</strong> - All key drivers and parameters</li>
                <li><strong>Rev & Exp Projections</strong> - Monthly revenue and expense details</li>
                <li><strong>Income Statement</strong> - Monthly P&L with margins</li>
                <li><strong>Cash Flow</strong> - Monthly cash flow statement</li>
                <li><strong>Balance Sheet</strong> - Monthly balance sheet</li>
                <li><strong>Annualized FS</strong> - Annual summary for FY 2028-2030</li>
            </ul>
        </div>

        <div class="info-section">
            <h3>üéØ Key Assumptions</h3>
            <div class="info-grid">
                <div class="info-item">
                    <strong>Start Date</strong>
                    January 2028
                </div>
                <div class="info-item">
                    <strong>Patients per Site</strong>
                    20/month
                </div>
                <div class="info-item">
                    <strong>PHP/IOP Mix</strong>
                    75%
                </div>
                <div class="info-item">
                    <strong>PHP Day Rate</strong>
                    $375
                </div>
                <div class="info-item">
                    <strong>Site 2 Opens</strong>
                    January 2030
                </div>
                <div class="info-item">
                    <strong>DOC Telehealth</strong>
                    Starts January 2030
                </div>
                <div class="info-item">
                    <strong>Initial Equity</strong>
                    $200,000
                </div>
                <div class="info-item">
                    <strong>Initial CAPEX</strong>
                    $250,000
                </div>
            </div>
        </div>
    </div>

    <script>
        function generateExcel() {
            const btn = document.getElementById('generateBtn');
            const status = document.getElementById('status');
            
            btn.disabled = true;
            btn.innerHTML = '<span class="icon">‚è≥</span> GENERATING...';
            status.className = 'status';
            status.textContent = '';
            
            try {
                // Create workbook
                const wb = XLSX.utils.book_new();
                
                // Helper function to create month dates
                function getMonthDate(monthIndex) {
                    const d = new Date(2028, monthIndex, 1);
                    d.setMonth(d.getMonth() + 1);
                    d.setDate(0); // Last day of month
                    return d;
                }
                
                // Create Assumptions sheet
                const assumptions = [
                    ['Fernly Health ‚Äî Model Assumptions'],
                    [],
                    ['Start Date (Model EOM)', new Date(2028, 0, 31)],
                    [],
                    ['Name', 'Value', 'Note'],
                    ['Patients_per_Site', 20, 'Avg active pts/mo per site'],
                    ['PHP_Mix', 0.75, 'Share in PHP/IOP'],
                    ['Avg_Days_Program', 15, 'PHP/IOP patient-days per program pt / month'],
                    ['Rate_PHP_Day', 375, 'Blended reimb per program day'],
                    ['Rate_MedMgmt', 150, 'Per med mgmt visit'],
                    ['Rate_Family', 120, 'Per family session'],
                    ['Rate_Individual', 100, 'Per individual session'],
                    ['Prog_MedMgmt_perPt', 2, 'Med mgmt visits/mo per program pt'],
                    ['Prog_Family_perPt', 1, 'Family sessions/mo per program pt'],
                    ['Prog_Indiv_perPt', 0.5, 'Indiv sessions/mo per program pt'],
                    ['OP_MedMgmt_perPt', 1, 'Med mgmt visits/mo per OP-only pt'],
                    ['OP_Indiv_perPt', 2, 'Indiv sessions/mo per OP-only pt'],
                    ['VarCost_per_ProgramDay', 10, 'Supplies/meal/etc per program day'],
                    ['Comp_PMHNP_Annual', 120000, 'PMHNP per site'],
                    ['Comp_Therapist_Annual', 65000, 'Per Therapist'],
                    ['Comp_RN_Annual', 70000, 'Per RN'],
                    ['Comp_Admin_Annual', 50000, 'Per Admin'],
                    ['Therapists_per_Site', 2, 'Therapists needed per site'],
                    ['RN_per_Site', 1, 'RNs per site'],
                    ['Admin_per_Site', 1, 'Admins per site'],
                    ['Rent_per_Site', 5000, '3,000 sqft @ ~$20/sqft/yr'],
                    ['Insurance_per_Site', 500, 'Monthly insurance'],
                    ['Utilities_per_Site', 600, 'Utilities & internet'],
                    ['EMR_per_Site', 500, 'EMR system'],
                    ['Marketing_per_Site', 1000, 'Ongoing marketing'],
                    ['Office_perEmp', 50, '$/emp/mo'],
                    ['IT_perEmp', 75, '$/emp/mo'],
                    ['Sales_Headcount', 2, 'Travel only'],
                    ['Travel_perSales', 500, '$/sales/mo'],
                    ['Postage_Monthly', 100, '$/mo'],
                    ['Misc_Monthly', 200, '$/mo'],
                    ['Site2_StartIndex', 24, 'Month index 24 = Jan-2030'],
                    ['DOC_StartIndex', 24, 'Month index 24 = Jan-2030'],
                    ['DOC_Patient_Days_per_Month', 300, 'Tele-IOP/PHP encounter-days/mo'],
                    ['DOC_Rate_per_Day', 150, '$ per encounter-day'],
                    ['TaxRate', 0.21, 'Corporate tax'],
                    ['Equity_Check_M1', 200000, 'Equity injected in first month'],
                    ['CAPEX_M1', 250000, 'Buildout/furniture/etc month 1']
                ];
                
                const wsAssumptions = XLSX.utils.aoa_to_sheet(assumptions);
                XLSX.utils.book_append_sheet(wb, wsAssumptions, 'Assumptions');
                
                // Create Revenue & Expense Projections (simplified version with calculated values)
                const revData = [
                    ['Fernly Revenue and Expense Projections'],
                    ['Date', ...Array.from({length: 36}, (_, i) => getMonthDate(i))],
                    ['Revenue Projections'],
                ];
                
                // Calculate monthly data
                const monthlyData = [];
                for (let m = 0; m < 36; m++) {
                    const activeSites = m >= 24 ? 2 : 1;
                    const totalPatients = 20 * activeSites;
                    const progPatients = totalPatients * 0.75;
                    const opPatients = totalPatients - progPatients;
                    const progDays = progPatients * 15;
                    const docDays = m >= 24 ? 300 : 0;
                    
                    const revPHP = progDays * 375;
                    const revMed = (progPatients * 2 + opPatients * 1) * 150;
                    const revFamily = progPatients * 1 * 120;
                    const revIndiv = (progPatients * 0.5 + opPatients * 2) * 100;
                    const revDOC = docDays * 150;
                    const totalRev = revPHP + revMed + revFamily + revIndiv + revDOC;
                    
                    const cogs = progDays * 10;
                    
                    const totalEmp = activeSites * (1 + 2 + 1 + 1) + 2;
                    const pmhnpWage = activeSites * 120000 / 12;
                    const therapistWage = activeSites * 2 * 65000 / 12;
                    const rnWage = activeSites * 1 * 70000 / 12;
                    const adminWage = activeSites * 1 * 50000 / 12;
                    const rent = activeSites * 5000;
                    const insurance = activeSites * 500;
                    const utilities = activeSites * 600;
                    const emr = activeSites * 500;
                    const marketing = activeSites * 1000;
                    const office = totalEmp * 50;
                    const it = totalEmp * 75;
                    const travel = 2 * 500;
                    const postage = 100;
                    const misc = 200;
                    
                    const opex = pmhnpWage + therapistWage + rnWage + adminWage + 
                                rent + insurance + utilities + emr + marketing + 
                                office + it + travel + postage + misc;
                    
                    monthlyData.push({
                        totalPatients, progPatients, opPatients, progDays, docDays,
                        revPHP, revMed, revFamily, revIndiv, revDOC, totalRev,
                        cogs, opex, activeSites, totalEmp
                    });
                }
                
                revData.push(
                    ['Total Patients (All Sites)', ...monthlyData.map(d => d.totalPatients)],
                    ['Program Patients (PHP/IOP)', ...monthlyData.map(d => d.progPatients)],
                    ['OP-only Patients', ...monthlyData.map(d => d.opPatients)],
                    ['Program Patient-Days', ...monthlyData.map(d => d.progDays)],
                    ['DOC Telehealth Patient-Days', ...monthlyData.map(d => d.docDays)],
                    ['PHP/IOP Revenue', ...monthlyData.map(d => d.revPHP)],
                    ['Medication Management Revenue', ...monthlyData.map(d => d.revMed)],
                    ['Family Therapy Revenue', ...monthlyData.map(d => d.revFamily)],
                    ['Individual Therapy Revenue', ...monthlyData.map(d => d.revIndiv)],
                    ['DOC Telehealth Revenue', ...monthlyData.map(d => d.revDOC)],
                    ['Total Monthly Revenue', ...monthlyData.map(d => d.totalRev)],
                    [],
                    ['Cost of Goods Sold Projections'],
                    ['Program Supplies', ...monthlyData.map(d => d.cogs)],
                    ['Total Monthly COGS', ...monthlyData.map(d => d.cogs)],
                    [],
                    ['Operating Expense Projections'],
                    ['Active Sites', ...monthlyData.map(d => d.activeSites)],
                    ['Total Monthly OpEx', ...monthlyData.map(d => d.opex)],
                    ['Total Monthly Expense', ...monthlyData.map(d => d.cogs + d.opex)]
                );
                
                const wsRev = XLSX.utils.aoa_to_sheet(revData);
                XLSX.utils.book_append_sheet(wb, wsRev, 'Rev & Exp Projections');
                
                // Create Income Statement
                const isData = [
                    ['Fernly Income Statement Projections'],
                    ['Date', ...Array.from({length: 36}, (_, i) => getMonthDate(i))],
                ];
                
                const isMonthly = monthlyData.map((d, i) => {
                    const revenue = d.totalRev;
                    const cogs = d.cogs;
                    const grossProfit = revenue - cogs;
                    const opex = d.opex;
                    const ebit = grossProfit - opex;
                    const pretax = ebit;
                    const tax = Math.max(0, pretax * 0.21);
                    const netIncome = pretax - tax;
                    
                    return {
                        revenue, cogs, grossProfit, opex, ebit, pretax, tax, netIncome,
                        growth: i === 0 ? 0 : (revenue - monthlyData[i-1].totalRev) / monthlyData[i-1].totalRev,
                        grossMargin: revenue === 0 ? 0 : grossProfit / revenue,
                        ebitMargin: revenue === 0 ? 0 : ebit / revenue
                    };
                });
                
                isData.push(
                    ['Revenue', ...isMonthly.map(d => d.revenue)],
                    ['% Growth', ...isMonthly.map(d => d.growth)],
                    ['(-) COGS Expense', ...isMonthly.map(d => d.cogs)],
                    ['Gross Profit', ...isMonthly.map(d => d.grossProfit)],
                    ['% Gross Margin', ...isMonthly.map(d => d.grossMargin)],
                    ['(-) Operating Expense', ...isMonthly.map(d => d.opex)],
                    ['Operating Income (EBIT)', ...isMonthly.map(d => d.ebit)],
                    ['% EBIT Margin', ...isMonthly.map(d => d.ebitMargin)],
                    ['(-) Interest Expense', ...Array(36).fill(0)],
                    ['Pretax Income', ...isMonthly.map(d => d.pretax)],
                    ['(-) Tax Expense', ...isMonthly.map(d => d.tax)],
                    ['Net Income', ...isMonthly.map(d => d.netIncome)]
                );
                
                const wsIS = XLSX.utils.aoa_to_sheet(isData);
                XLSX.utils.book_append_sheet(wb, wsIS, 'Income Statement');
                
                // Create Cash Flow Statement
                const cfData = [
                    ['Fernly Cash Flow Statement Projections'],
                    ['Date', ...Array.from({length: 36}, (_, i) => getMonthDate(i))],
                ];
                
                const cfMonthly = isMonthly.map((d, i) => {
                    const ni = d.netIncome;
                    const da = 0;
                    const nwc = 0;
                    const cfo = ni + da + nwc;
                    const capex = i === 0 ? -250000 : 0;
                    const cfi = 0;
                    const debt = 0;
                    const equity = i === 0 ? 200000 : 0;
                    const cff = debt + equity;
                    const netChange = cfo + capex + cff;
                    
                    return { ni, da, nwc, cfo, capex, cfi, debt, equity, cff, netChange };
                });
                
                cfData.push(
                    ['Net Income', ...cfMonthly.map(d => d.ni)],
                    ['(+) D&A', ...cfMonthly.map(d => d.da)],
                    ['(+) Changes in NWC', ...cfMonthly.map(d => d.nwc)],
                    ['Cash Flow from Operations', ...cfMonthly.map(d => d.cfo)],
                    ['(-) Capital Expenditures', ...cfMonthly.map(d => d.capex)],
                    ['Cash Flow from Investing', ...cfMonthly.map(d => d.cfi)],
                    ['(+) Debt Issuance', ...cfMonthly.map(d => d.debt)],
                    ['(+) Equity Issuance', ...cfMonthly.map(d => d.equity)],
                    ['Cash Flow from Financing', ...cfMonthly.map(d => d.cff)],
                    ['Net Change in Cash', ...cfMonthly.map(d => d.netChange)]
                );
                
                const wsCF = XLSX.utils.aoa_to_sheet(cfData);
                XLSX.utils.book_append_sheet(wb, wsCF, 'Cash Flow');
                
                // Create Balance Sheet
                const bsData = [
                    ['Fernly Balance Sheet Projections'],
                    ['Date', ...Array.from({length: 36}, (_, i) => getMonthDate(i))],
                    ['Assets'],
                ];
                
                let cash = 0;
                const cashByMonth = cfMonthly.map(d => {
                    cash += d.netChange;
                    return cash;
                });
                
                let retainedEarnings = 0;
                const reByMonth = isMonthly.map(d => {
                    retainedEarnings += d.netIncome;
                    return retainedEarnings;
                });
                
                bsData.push(
                    ['Cash', ...cashByMonth],
                    ['Total Assets', ...cashByMonth],
                    ['Liabilities'],
                    ['Long-term Debt', ...Array(36).fill(0)],
                    ['Total Liabilities', ...Array(36).fill(0)],
                    ["Shareholder's Equity"],
                    ['Common Stock', ...Array(36).fill(20)],
                    ['Additional Paid-in Capital', ...Array(36).fill(200000)],
                    ['Retained Earnings', ...reByMonth],
                    ["Total Shareholder's Equity", ...reByMonth.map(re => 20 + 200000 + re)],
                    ['Balance Check', ...cashByMonth.map((c, i) => c - (20 + 200000 + reByMonth[i]))]
                );
                
                const wsBS = XLSX.utils.aoa_to_sheet(bsData);
                XLSX.utils.book_append_sheet(wb, wsBS, 'Balance Sheet');
                
                // Create Annualized FS
                const sumRange = (arr, start, end) => arr.slice(start, end).reduce((a, b) => a + b, 0);
                
                const annualData = [
                    ['Fernly Annualized Financial Statement Projections'],
                    [],
                    ['', 'FY 2028', 'FY 2029', 'FY 2030'],
                    [],
                    ['Income Statement'],
                    ['Revenue', 
                        sumRange(isMonthly.map(d => d.revenue), 0, 12),
                        sumRange(isMonthly.map(d => d.revenue), 12, 24),
                        sumRange(isMonthly.map(d => d.revenue), 24, 36)
                    ],
                    ['(-) COGS Expense',
                        sumRange(isMonthly.map(d => d.cogs), 0, 12),
                        sumRange(isMonthly.map(d => d.cogs), 12, 24),
                        sumRange(isMonthly.map(d => d.cogs), 24, 36)
                    ],
                    ['Gross Profit',
                        sumRange(isMonthly.map(d => d.grossProfit), 0, 12),
                        sumRange(isMonthly.map(d => d.grossProfit), 12, 24),
                        sumRange(isMonthly.map(d => d.grossProfit), 24, 36)
                    ],
                    ['(-) Operating Expense',
                        sumRange(isMonthly.map(d => d.opex), 0, 12),
                        sumRange(isMonthly.map(d => d.opex), 12, 24),
                        sumRange(isMonthly.map(d => d.opex), 24, 36)
                    ],
                    ['Operating Income (EBIT)',
                        sumRange(isMonthly.map(d => d.ebit), 0, 12),
                        sumRange(isMonthly.map(d => d.ebit), 12, 24),
                        sumRange(isMonthly.map(d => d.ebit), 24, 36)
                    ],
                    ['Net Income',
                        sumRange(isMonthly.map(d => d.netIncome), 0, 12),
                        sumRange(isMonthly.map(d => d.netIncome), 12, 24),
                        sumRange(isMonthly.map(d => d.netIncome), 24, 36)
                    ],
                    [],
                    ['Balance Sheet (Year-End)'],
                    ['Cash', cashByMonth[11], cashByMonth[23], cashByMonth[35]],
                    ['Total Assets', cashByMonth[11], cashByMonth[23], cashByMonth[35]],
                    ['Retained Earnings', reByMonth[11], reByMonth[23], reByMonth[35]]
                ];
                
                const wsAnnual = XLSX.utils.aoa_to_sheet(annualData);
                XLSX.utils.book_append_sheet(wb, wsAnnual, 'Annualized FS');
                
                // Generate and download
                XLSX.writeFile(wb, 'Fernly_Financials_2028-2030.xlsx');
                
                status.className = 'status success';
                status.textContent = '‚úÖ SUCCESS! Excel file generated and downloaded. Check your downloads folder for "Fernly_Financials_2028-2030.xlsx"';
                btn.disabled = false;
                btn.innerHTML = '<span class="icon">‚¨áÔ∏è</span> CLICK HERE TO GENERATE EXCEL FILE';
                
            } catch (error) {
                status.className = 'status error';
                status.textContent = '‚ùå Error generating file: ' + error.message;
                btn.disabled = false;
                btn.innerHTML = '<span class="icon">‚¨áÔ∏è</span> CLICK HERE TO GENERATE EXCEL FILE';
                console.error(error);
            }
        }
    </script>
</body>
</html>
